<!DOCTYPE html>
<html>
    <head>
        <title>Tanks!</title>
        <style>
* {
    padding: 0;
    margin: 0;
    font-size: min(5vw, 5vh);
    font-family: monospace;
    
    touch-action: manipulation;
}

body {
    padding: 1em;
    background-color: #2c8520;
}

#loader {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin: 0 auto;
    position: relative;
    background-color: #42cf30;
    margin: 1em;
    vertical-align: bottom;
    position: absolute;
    bottom: 0;
    left: 0;
    max-height: calc(100vh - 2em);
    width: calc(100vw - 2em);
}

#loader * {
    height: 100%;
    width: 100%;
    margin: .5rem;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    outline: 0;
    display: block;
}

#loader input {
    font-family: Courier;
}

#loader #nickname {
    width: 13rem;
}

#loader #playButton {
    padding-left: .5em;
    padding-right: .5em;
    width: auto;
    display: none;
}

#loader span {
    width: 100%;
    margin: 0;
    padding: 0;
    border: 0;
    height: 0;
}

#loader p:not(#status) {
    font-weight: normal;
    font-size: 4rem;
    font-family: Courier;
}

#content {
    overflow: hidden;
    position: fixed;
    top: 0;
    left: 0;
    display: none;
}
        </style>
    </head>
    <body>
        <div id="loader">
            <p>Tanks!</p>
            <input id="nickname" type="text" placeholder="nickname" autocomplete="off" spellcheck="false" maxlength="20">
            <p id="status">please enable javascript to connect</p>
            <span></span>
            <input id="playButton" type="button" value="Play">
        </div>
        <div id="content">
            <canvas id="canvas" width="100" height="100"></canvas>
        </div>
        <script>
var webSocket = null;
var loaderManager;

var drawing = false;

var loader = document.getElementById("loader");
var playButton = document.getElementById("playButton");
var content = document.getElementById("content");

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

var lastFrame = 0;

var tanks = []
var tank;

function initialize() {
    loaderManager = new ConnectLoader();
    resize();
    
    connect();
    setTimeout(() => {
        tank = new Tank(200, 200, 1.4, ['s','d'], "your mom", 234234, [], 100, 20);
    }, 5000);
}

window.onload = function(e) {
    canvas.addEventListener("mousemove", function(e){
        if (typeof tank !== "undefined") {
            let x = e.clientX - tank.x - (tank.width/2);
            let y = e.clientY - tank.y - (tank.height/2);
            if (x < 0) {
                tank.rot = Math.atan(y/x) + Math.PI;
            } else {
                tank.rot = Math.atan(y/x);
            }
        }
    });
    
    playButton.addEventListener("click", () => {
        drawing = true;
        new Promise((resolve, reject) => {
            loader.style.display = "none";
            content.style.display = "block";
            setInterval(() => {
                if (drawing) {
                    let diff = window.performance.now()-lastFrame;
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.save();
                    ctx.fillStyle = "green";
                    tanks.forEach((tank) => {
                        ctx.save();
                        ctx.translate(tank.x + tank.width/2, tank.y + tank.height/2);
                        ctx.rotate(0);
                        ctx.fillText("drawing " + tank.name, 20, 0);
                        let rot = 0;
                        if (tank.keys.includes("w") && tank.keys.includes("d")) {
                            rot = 7*Math.PI/4;
                        } else if (tank.keys.includes("d") && tank.keys.includes("s")) {
                            rot = Math.PI/4;
                        } else if (tank.keys.includes("s") && tank.keys.includes("a")) {
                            rot = 3*Math.PI/4;
                        } else if (tank.keys.include("a") && tank.keys.includes("w")) {
                            rot = 5*Math.PI/4;
                        } else if (tank.keys.includes("w")) {
                            rot = 3*Math.PI/2
                        } else if (tank.keys.includes("d")) {
                            rot = 0;
                        } else if (tank.keys.includes("s")) {
                            rot = Math.PI/2
                        } else if (tank.keys.includes("a")) {
                            rot = Math.PI;
                        }
                        
                        ctx.save();
                        ctx.rotate(rot);
                        ctx.fillStyle = "#1a7022"
                        ctx.fillRect(-tank.width/2/2, -tank.height/2, tank.width/2, tank.height);
                        ctx.restore();
                        ctx.rotate(tank.rot);
                        ctx.fillStyle = "#00ff18";
                        ctx.fillRect(0, -2/2, 20, 2);
                        ctx.restore();
                        tank.bullets.forEach((bullet) => {
                            ctx.save();
                            ctx.translate(bullet.x + 5/2, bullet.y + 5/2);
                            ctx.rotate(0);
                            ctx.fillText("bullet", 20, 0);
                            ctx.rotate(bullet.rot);
                            ctx.fillRect(-5/2, -5/2, 5, 5);
                            ctx.restore();
                        });
                    });
                    
                    ctx.restore();
                    ctx.fillStyle = "white";
                    ctx.font = "20pt Comic Sans MS";
                    ctx.fillText(Math.round(1000/diff) + "fps", 20, 20);
                    
                    lastFrame = window.performance.now();
                } else {
                    loader.style.display = "block";
                    content.style.display = "none";

                    resolve();
                }
            }, 1000/60);
        });
    });
    window.addEventListener("resize", resize);
}

function connect() {
    console.log("Connecting to server...");
    new Promise((resolve, reject) => {
        loaderManager.update();
    });
    webSocket = new WebSocket("ws://localhost:80");

    webSocket.onopen = function(e) {
        console.log("Connected to server");
        loaderManager.onOpen();
    }

    webSocket.onclose = function(e) {
        console.log("Connection closed, attempting to reconnect...");
        reconnect = setTimeout(connect, 1000);
    }

    webSocket.onmessage = function(e) {
        console.log(event.data);
    }
}

function send(payload) {
    if(webSocket.readyState == WebSocket.OPEN) {
        webSocket.send(payload);
    } else {
        return "Error: Not connected";
    }
}

class ConnectLoader { //todo unnecessary class?
    constructor() {
        this.dots = 0;
        this.running = false;
        this.status = document.getElementById("status");
    }

    update(go) {
        if (!this.running || go) {
            this.running = true;
            if (webSocket === null || webSocket.readyState !== WebSocket.OPEN) {
                this.status.style.display = "block";
                playButton.style.display = "none";
                if (this.dots > 3) {
                    this.dots = 0;
                }
            
                let dot = "";
                let begin = "";
                for (let i = 0; i < this.dots; i++) {
                    dot = dot + ".";
                    begin = begin + "&nbsp";
                }
                
                this.status.innerHTML = begin + "connecting" + dot;
              
                this.dots++;
                setTimeout(() => {
                    this.update(true);
                }, 250);
            } else {
                this.running = false;
            }
        }
    }
    
    onOpen() {
        this.status.innerHTML = "connected";
        this.status.style.display = "none";
        playButton.style.display = "block";
    }
}

/* 
canvas 
*/

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    ctx.imageSmoothingEnabled = "false";
}

class Tank {
    constructor(x, y, rot, keys, name, id, bullets, width, height) {
        this.x = x;
        this.y = y;
        this.rot = rot;
        this.keys = keys;
        this.name = name;
        this.id = id;
        this.bullets = bullets;
        this.width = width;
        this.height = height;
        tanks[id] = this;
    }
    
    move(x, y, rot, keys) {
        this.x = x;
        this.y = y;
        this.rot = rot;
        this.keys = keys;
    }
    
    shoot(rot) {
        this.bullets.push(new Bullet(this.x, this.y, rot, 0));
    }
}

class Bullet {
    constructor(x, y, rot, hits) {
        this.x = x;
        this.y = y;
        this.rot = rot;
        this.hits = hits;
    }
}

initialize();
        </script>
    </body>
</html>